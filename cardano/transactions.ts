import {
  Lucid,
  Data,
  Construct,
  C,
  SpendingValidator,
  fromHex,
  Tx,
} from "lucid-cardano";
import { toHex } from "@utils";

// TODO put these to config
const jpgV2Script: SpendingValidator = {
  type: "PlutusV1",
  script:
    "590fc1590fbe0100003233223232323322333222323233322232333222323332223322323322323332223232332233223232332232323332223322332233223322323232323232323232323232332232323232323232323322323232332232333322223232323232322232232325335305c33223530310012235303500222222222322235304400c23232325335306f333222533530723300300200110731074506e32353047001220023253353505a00113507649010350543800221002302e5002004107115335304a01313301b49101350033355029302f1200123535505e00122323355030335502d30331200123535506200122353550640012253353506f335503533550250490040062153353507033550363335550323039120012235355069002232233225335350770022130020011507800425335350763335502c0500040072153353080013304d0010031335503d5079300400215335308001330630010031335503d507933335502e0510053304900100300215078150773200135508601225335350680011506a2213535506e002225335308201330530020071003133506d33550710020013006003350720010022133026491023130003322333573466e200080041f41f8cc8cd54c0ec48004d40c00048004cd40c40952000335530321200123535506900122001001004133573892010231310007a133573892010231320007900233233553023120013503500135034001335038223355302c120012353550630012233550660023355302f12001235355066001223355069002333535502b0012330264800000488cc09c0080048cc09800520000013355302c1200123535506300122335506600233353550280012335530301200123535506700122335506a00235502f0010012233355502804a0020012335530301200123535506700122335506a00235502d001001333555023045002001505e33233553023120012253353506c3003002213350610010021001505f2353053001222533530763332001504100600313506f0021506e011320013333555028302f1200122353055002225335307333044002500b10031333355502c303312001235305a00122253353506e333550245042003001213333550265043004335530301200123535506700122335506a002333535502c0012001223535506b002223535506d0032233550703302c00400233553039120012353550700012233550730023335355035001200122330310020012001333555030052003001200133355502704900300100213333550255042003002001003001505b500113301b49101340033355029302f1200123530540012233043500a00250011533535058335530401200123320015051320013530460012235305100122253353506b0012321300100d3200135507f2253353506100113507d491022d310022135355067002225335307b3304c00200710011300600313507a49101370050011350744901013600221335530421200123320015053320013530480012235305300122253353506d0012321300100f32001355081012253353506300113507f491022d310022135355069002225335307d3304e00200710011300600313507c4910137005003133355301d12001225335306f335306a303e302d35304600222001207125335307033041001300401010721350764901013300133505a0020011001505900d3200135507622533535058001135074491022d31002213530470022253353072333200150710020071353063303000122335306f00223507b491022d310020011300600315335350520011306d4988854cd4d41500044008884c1c5263333573466e1d40112002203a23333573466e1d40152000203a23263530663357380b80ce0ca0c80c66666ae68cdc39aab9d5002480008cc0c4c8c8c8c8c8c8c8c8c8c8c8cccd5cd19b8735573aa01490001199999999981f99a828919191999ab9a3370e6aae7540092000233045304b35742a00460986ae84d5d1280111931a983a99ab9c06b076074073135573ca00226ea8004d5d0a80519a8288241aba1500935742a0106ae85401cd5d0a8031aba1500535742a00866a0a2eb8d5d0a80199a82899aa82b3ae200135742a0046ae84d5d1280111931a983899ab9c06707207006f135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135573ca00226ea8004d5d0a80119191999ab9a3370e6aae75400520022303a303e357426aae7940088c98d4c1a0cd5ce02f03483383309baa001357426ae8940088c98d4c194cd5ce02d833032031883289931a983219ab9c49010350543500065063135573ca00226ea80044d55ce9baa001223370000400244a66a60ac00220b0266ae7000815c4488c88c008004c8004d5417c894cd4d41040045413c884d4d5411c008894cd4c16ccc02000801c4d41500044c01800c448888c8cd54c03c480048d4d5411800488cd54124008ccd4d5402c0048004880048004ccd554018014008004c8cd40054109410c488cc008cd5411c014010004444888ccd54c0104800540fccd54c030480048d4d5410c00488cd54118008d5402c004ccd54c0104800488d4d54110008894cd4c160ccd54c06048004d4034cd403c894cd4c168008417040041648d4d5411c00488cc028008014018400c4cd410c01000d4100004cd54c030480048d4d5410c00488c8cd5411c00cc004014c8004d54184894cd4d410c0044d5402c00c884d4d54124008894cd4c174cc0300080204cd5404001c0044c01800c008c8004d5416888448894cd4d40fc0044008884cc014008ccd54c01c480040140100044484888c00c01044884888cc0080140104484888c00401044800448cd404888ccd4d401000c88008008004d4d40080048800448848cc00400c00848004c8004d541488844894cd4d40d8004540e0884cd40e4c010008cd54c018480040100044448888cccd54011403c00c0040084488cd54008c8cd403c88ccd4d401800c88008008004d4d401000488004cd401005012800448848cc00400c008480044488c0080048d4c08c00488800cc8004d5412c88c8c94cd4c114cc0a14009200213300c300433530081200150010033004335300d12001500100310031332233706004002a002900209999aa9801890009919a80511199a8040018008011a802800a8039119b800014800800520003200135504a221122253353502f00113500600322133350090053004002333553007120010050040011235350050012200112353500400122002320013550472212253353041333573466e2400920000430421502d153353502b0011502d22133502e002335300612001337020089001000899a801111180198010009000891091980080180109000990009aa821911299a9a81300108009109a980a801111a982180111299a9a8160038a99a9a8160038804110b1109a980d801111a982480111299a9824199ab9a33720010004094092266a0660186601e01601a2a66a6090666ae68cdc8804001024825099a819803198078070028a99a982419809003800899a81980619807805806899a81980319807807002990009aa82111091299a9a8130008a814110a99a981f19804002240002006266a600c240026600e00890010009119b8100200122333573466e240080040e80e4488cc00ccc01cc018008c018004cc894cd4d40c0008854cd4d40c400884cd4c0b80088cd4c0bc0088cc034008004888100888cd4c0c401081008894cd4c104ccd5cd19b87006003043042153353041333573466e1c01400810c1084cc0380100044108410840ec54cd4d40c0004840ec40ecc014008c014004894cd4c0d8008400440dc88ccd5cd19b8700200103703623530240012200123530230012200222335302d0022335302e00223300500200120352335302e002203523300500200122333573466e3c0080040cc0c8c8004d540e08844894cd4d407000454078884cd407cc010008cd54c018480040100048848cc00400c0088004888888888848cccccccccc00402c02802402001c01801401000c00880048848cc00400c0088004848c004008800448800848800480048c8c8cccd5cd19b8735573aa004900011981519191999ab9a3370e6aae75400520002375c6ae84d55cf280111931a981899ab9c02703203002f137540026ae854008dd69aba135744a004464c6a605c66ae700900bc0b40b04d55cf280089baa00123232323333573466e1cd55cea801a4000466600e602c6ae85400cccd5403dd719aa807bae75a6ae854008cd4071d71aba135744a004464c6a605c66ae700900bc0b40b04d5d1280089aab9e5001137540024442466600200800600440022464646666ae68cdc39aab9d5002480008cc88cc024008004dd71aba1500233500a232323333573466e1cd55cea80124000466446601e004002602c6ae854008ccd5403dd719aa809919299a981419805a800a40022a00226a05c921022d33001375a00266aa01eeb88c94cd4c0a0cc02d400520001500113502e491022d32001375a0026ae84d5d1280111931a981719ab9c02402f02d02c135573ca00226ea8004d5d09aba25002232635302a33573804005605205026aae7940044dd500091199ab9a33712004002040042442466002006004400244246600200600440022464460046eb0004c8004d5408c88cccd55cf80092804119a80398021aba1002300335744004048224464460046eac004c8004d5408c88c8cccd55cf80112804919a80419aa80618031aab9d5002300535573ca00460086ae8800c0944d5d0800889100109109119800802001890008891119191999ab9a3370e6aae754009200023355008300635742a004600a6ae84d5d1280111931a981099ab9c01702202001f135573ca00226ea8004448848cc00400c0084480048c8c8cccd5cd19b8735573aa004900011980318071aba1500233500a2323232323333573466e1d40052002233300e375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea004900011808180a9aba135573ca00c464c6a604666ae700640900880840804d55cea80189aba25001135573ca00226ea8004d5d09aba25002232635301c33573802403a03603426aae7940044dd5000910919800801801100090911801001911091199800802802001900089119191999ab9a3370ea002900011a80418029aba135573ca00646666ae68cdc3a801240044a010464c6a603066ae7003806405c0580544d55cea80089baa001121223002003112200112001232323333573466e1d4005200223006375c6ae84d55cf280191999ab9a3370ea0049000118041bae357426aae7940108c98d4c04ccd5ce00480a00900880809aab9d50011375400242446004006424460020064002921035054310012253353003333573466e3cd4c01800888008d4c018004880080140104ccd5cd19b873530060022200135300600122001005004100412200212200120012212330010030022001235002490101310012326353003335738002008004930900090008891918008009119801980100100081",
};
const jpgV2ScriptAddr =
  "addr1zxj47sy4qxlktqzmkrw8dahe46gtv8seakrshsqz26qnvzypw288a4x0xf8pxgcntelxmyclq83s0ykeehchz2wtspksr3q9nx";
const feeRate = 0.02;
const feeAddr =
  "addr1q9cwvremt6n320s2e3agq0jyq82yhrk3htsu0w426xnz5us70z4w0jgvcdkkynmm8wmds66jd9kusnjfpu6raw5fqp0sr07p5w";
const minFee = 1000000;
const minRoyalty = 1000000;

export type Royalty = {
  address: string;
  rate: number;
};

export type ListingParams = {
  policyId: string;
  tokenNameHex: string;
  price: number;
  royalty?: Royalty;
};

export type DatumParams = ListingParams & { sellerAddr: string };

type RedeemAction = "CANCEL";

const redeemerConstructors: { [action: string]: number } = {
  CANCEL: 0,
};

function getRedeemer(action: RedeemAction) {
  return Data.to(new Construct(redeemerConstructors[action], []));
}

function addrToPkhHex(addr: string) {
  // TODO rewrite this without the use of C
  const pkh = C.BaseAddress.from_address(C.Address.from_bech32(addr))
    ?.payment_cred()
    .to_keyhash();
  if (!pkh) {
    throw new Error("INVALID_ADDR");
  }
  return toHex(pkh.to_bytes());
}

function addrToStakingCredHex(addr: string) {
  // TODO rewrite this without the use of C
  const stakingCredHash = C.BaseAddress.from_address(
    C.Address.from_bech32(addr)
  )
    ?.stake_cred()
    .to_keyhash();
  if (!stakingCredHash) {
    throw new Error("INVALID_ADDR");
  }
  return toHex(stakingCredHash.to_bytes());
}

type Payout = {
  addr: string;
  lovelace: number;
};

function splitPrice(price: number, royalty: Royalty | undefined) {
  const feeLovelace = Math.max(minFee, Math.floor(price * feeRate));
  const royaltyLovelace =
    royalty && royalty.rate > 0
      ? Math.max(minRoyalty, Math.floor(price * royalty?.rate))
      : 0;
  return {
    sellerLovelace: price - feeLovelace - royaltyLovelace,
    feeLovelace,
    royaltyLovelace,
  };
}

function makePayouts(datumParams: DatumParams): Payout[] {
  const payoutValues = splitPrice(datumParams.price, datumParams.royalty);
  const payouts = [];
  if (datumParams.royalty && payoutValues.royaltyLovelace > 0) {
    payouts.push({
      addr: datumParams.royalty.address,
      lovelace: payoutValues.royaltyLovelace,
    });
  }
  payouts.push({
    addr: feeAddr,
    lovelace: payoutValues.feeLovelace,
  });
  payouts.push({
    addr: datumParams.sellerAddr,
    lovelace: payoutValues.sellerLovelace,
  });
  return payouts;
}

function addrToData(addr: string) {
  const paymentCredData = new Construct(0, [addrToPkhHex(addr)]);
  const stakingCredData = new Construct(0, [
    new Construct(0, [new Construct(0, [addrToStakingCredHex(addr)])]),
  ]);
  return new Construct(0, [paymentCredData, stakingCredData]);
}

function payoutToData(payout: Payout) {
  const payoutValue = new Map([
    ["", new Construct(0, [0, new Map([["", payout.lovelace]])])],
  ]);
  return new Construct(0, [addrToData(payout.addr), payoutValue]);
}

function buildDatum(lucid: Lucid, datumParams: DatumParams) {
  const sellerPkhHex = addrToPkhHex(datumParams.sellerAddr);

  const payouts = makePayouts(datumParams);
  const payoutsData = [];
  for (const payout of payouts) {
    payoutsData.push(payoutToData(payout));
  }

  const datumFields = [sellerPkhHex, payoutsData];
  const fullData = new Construct(0, datumFields);
  return Data.to(fullData);
}

async function attachSellOrderMetadata(tx: Tx, datum: string) {
  // Greedily split the datum into pieces of length at most 64
  const splitDatumParts = datum.match(/.{1,64}/g);
  if (!splitDatumParts) {
    throw new Error("UNKNOWN_ERROR");
  }
  for (const [label, metadataRow] of [...splitDatumParts].entries()) {
    tx = await tx.attachMetadata(label, metadataRow);
  }
  tx = await tx.attachMetadata(30, "2"); // Sell order marker
  return tx;
}

export async function makeJpgV2Listing(
  listingParams: ListingParams,
  lucid: Lucid
): Promise<string> {
  const sellerAddr = await lucid.wallet.address();

  const listingDatum = buildDatum(lucid, { ...listingParams, sellerAddr });

  const nftAndDepositAssets = {
    lovelace: BigInt(2000000),
    [listingParams.policyId + listingParams.tokenNameHex]: BigInt(1),
  };

  let newTx = await lucid.newTx();
  newTx = await attachSellOrderMetadata(newTx, listingDatum);
  const tx = await newTx
    .payToContract(jpgV2ScriptAddr, listingDatum, nftAndDepositAssets)
    .complete();

  const signedTx = await tx.sign().complete();
  const txHash = await signedTx.submit();
  return txHash;
}

export async function cancelJpgV2Listing(
  listingParams: ListingParams,
  lucid: Lucid
): Promise<string> {
  const sellerAddr = await lucid.wallet.address();

  const listingDatum = buildDatum(lucid, { ...listingParams, sellerAddr });

  const listingUtxos = (
    await lucid.utxosAtWithUnit(
      jpgV2ScriptAddr,
      listingParams.policyId + listingParams.tokenNameHex
    )
  ).filter((utxo) => {
    return (
      utxo.datumHash &&
      utxo.datumHash ==
        C.hash_plutus_data(
          C.PlutusData.from_bytes(fromHex(listingDatum))
        ).to_hex()
    );
  });
  if (listingUtxos.length == 0) {
    throw new Error("NOT_IN_SCRIPT");
  }

  const tx = await lucid
    .newTx()
    .collectFrom([listingUtxos[0]], getRedeemer("CANCEL"))
    .attachSpendingValidator(jpgV2Script)
    .addSigner(sellerAddr)
    .complete({ datum: listingDatum });

  const signedTx = await tx.sign().complete();

  const txHash = await signedTx.submit();

  return txHash;
}
